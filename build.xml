<?xml version="1.0" encoding="UTF-8"?>
<project name="ace-cp4i-deploy" default="deploy" basedir=".">

  <!-- ================== PROPERTIES ================== -->
  <!-- BAR from Git checkout path -->
  <property name="BAR_FILE" value="target/SampleGetApi.regenerated.bar"/>
  <property name="IR_NAME" value="server-5"/>
  <property name="NAMESPACE" value="cp4i"/>

  <!-- GitHub repo details -->
  <property name="GITHUB_REPO" value="github.com/Saikiran9824-pronteff/ace-saikiran.git"/>
  <property name="GITHUB_BRANCH" value="main"/>
  <property name="GITHUB_PATH" value="bars/SampleGetApi.regenerated.bar"/>
  <!-- Token will be injected by Jenkins credentials -->
  <property environment="env"/>
  <property name="GITHUB_TOKEN" value="${env.GITHUB_TOKEN}"/>

  <!-- OCP cluster details -->
  <property name="OCP_URL" value="https://api.ocp.prontefflabs.com:6443"/>
  <property name="OCP_TOKEN" value="${env.OCP_TOKEN}"/>

  <!-- ================== LOGIN TO OCP ================== -->
  <target name="oc-login">
    <echo message="🔐 Logging into OpenShift..."/>
    <exec executable="oc" failonerror="true">
      <arg value="login"/>
      <arg value="${OCP_URL}"/>
      <arg value="--token=${OCP_TOKEN}"/>
      <arg value="--insecure-skip-tls-verify=true"/>
    </exec>
    <exec executable="oc" failonerror="true">
      <arg value="project"/>
      <arg value="${NAMESPACE}"/>
    </exec>
  </target>

  <!-- ================== PUSH BAR TO GITHUB ================== -->
  <target name="upload-github">
    <echo message="📦 Uploading BAR to GitHub repo: ${GITHUB_REPO}"/>
    <exec executable="git" failonerror="true">
      <arg value="config"/>
      <arg value="--global"/>
      <arg value="user.email"/>
      <arg value="ci-bot@example.com"/>
    </exec>
    <exec executable="git" failonerror="true">
      <arg value="config"/>
      <arg value="--global"/>
      <arg value="user.name"/>
      <arg value="ci-bot"/>
    </exec>
    <exec executable="git" failonerror="true">
      <arg value="clone"/>
      <arg value="https://${GITHUB_TOKEN}@${GITHUB_REPO}"/>
      <arg value="repo"/>
    </exec>
    <exec executable="bash" failonerror="true">
      <arg value="-c"/>
      <arg value="cp ${BAR_FILE} repo/${GITHUB_PATH}"/>
    </exec>
    <exec executable="bash" failonerror="true">
      <arg value="-c"/>
      <arg value="cd repo &amp;&amp; git add ${GITHUB_PATH} &amp;&amp; git commit -m 'CI: Update BAR' &amp;&amp; git push origin ${GITHUB_BRANCH}"/>
    </exec>
  </target>

  <!-- ================== PATCH INTEGRATIONRUNTIME ================== -->
  <target name="patch-ir" depends="upload-github,oc-login">
    <echo message="🚀 Patching IntegrationRuntime ${IR_NAME} with BAR from GitHub..."/>
    <exec executable="oc" failonerror="true">
      <arg value="patch"/>
      <arg value="integrationruntime"/>
      <arg value="${IR_NAME}"/>
      <arg value="--type=merge"/>
      <arg value="-p"/>
      <arg>
        <![CDATA[{ "spec": { "barURL": [ "https://raw.githubusercontent.com/YourOrg/ace-bars/${GITHUB_BRANCH}/${GITHUB_PATH}" ] } }]]>
      </arg>
    </exec>
  </target>

  <!-- ================== VERIFY ROLLOUT ================== -->
  <target name="verify" depends="patch-ir">
    <echo message="🔍 Waiting for IntegrationRuntime pod to restart..."/>
    <exec executable="oc" failonerror="true">
      <arg value="wait"/>
      <arg value="--for=condition=Ready"/>
      <arg value="pod"/>
      <arg value="-l"/>
      <arg value="app.kubernetes.io/instance=${IR_NAME}"/>
      <arg value="--timeout=300s"/>
      <arg value="-n"/>
      <arg value="${NAMESPACE}"/>
    </exec>
    <echo message="✅ BAR Deployment Completed Successfully!"/>
  </target>

  <!-- ================== MAIN ENTRY ================== -->
  <target name="deploy" depends="verify"/>

</project>
