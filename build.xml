<?xml version="1.0" encoding="UTF-8"?>
<project name="ace-cp4i-deploy" default="deploy" basedir=".">

  <!-- ================== PROPERTIES ================== -->
  <!-- BAR from Git checkout path -->
  <property name="BAR_FILE" value="target/myApp.bar"/>
  <property name="IR_NAME" value="server-5"/>
  <property name="OCP_URL" value="https://api.ocp.prontefflabs.com:6443"/>
  <property name="NAMESPACE" value="cp4i"/>

  <!-- Token from Jenkins credentials -->
  <property environment="env"/>
  <property name="OCP_TOKEN" value="${env.OCP_TOKEN}"/>

  <!-- ================== LOGIN ================== -->
  <target name="oc-login">
    <echo message="🔐 Logging into OpenShift..."/>
    <exec executable="oc" failonerror="true">
      <arg value="login"/>
      <arg value="${OCP_URL}"/>
      <arg value="--token=${OCP_TOKEN}"/>
      <arg value="--insecure-skip-tls-verify=true"/>
    </exec>
    <exec executable="oc" failonerror="true">
      <arg value="project"/>
      <arg value="${NAMESPACE}"/>
    </exec>
  </target>

  <!-- ================== CREATE CONFIGMAP ================== -->
  <target name="create-configmap" depends="oc-login">
    <echo message="📦 Creating BAR ConfigMap from Git checkout..."/>
    <exec executable="oc" failonerror="false">
      <arg value="delete"/>
      <arg value="configmap"/>
      <arg value="ace-bar-cm"/>
      <arg value="--ignore-not-found"/>
    </exec>
    <exec executable="oc" failonerror="true">
      <arg value="create"/>
      <arg value="configmap"/>
      <arg value="ace-bar-cm"/>
      <arg value="--from-file=${BAR_FILE}"/>
    </exec>
  </target>

  <!-- ================== PATCH INTEGRATION RUNTIME ================== -->
  <target name="patch-ir" depends="create-configmap">
    <echo message="🚀 Patching IntegrationRuntime ${IR_NAME} with new BAR ConfigMap..."/>
    <exec executable="oc" failonerror="true">
      <arg value="patch"/>
      <arg value="integrationruntime"/>
      <arg value="${IR_NAME}"/>
      <arg value="--type=merge"/>
      <arg value="-p"/>
      <arg value='{"spec":{"configurations":["ace-bar-cm","${IR_NAME}-ir-adminssl","serverconfig"]}}'/>
    </exec>
  </target>

  <!-- ================== VERIFY ================== -->
  <target name="verify" depends="patch-ir">
    <echo message="🔍 Checking pod rollout for IntegrationRuntime ${IR_NAME}..."/>
    <!-- Debug: show all pods and labels -->
    <exec executable="oc" failonerror="false">
      <arg value="get"/>
      <arg value="pods"/>
      <arg value="-n"/>
      <arg value="${NAMESPACE}"/>
      <arg value="--show-labels"/>
    </exec>
    <!-- Wait for pods with the IntegrationRuntime label -->
    <exec executable="oc" failonerror="true">
      <arg value="wait"/>
      <arg value="--for=condition=Ready"/>
      <arg value="pod"/>
      <arg value="-l"/>
      <arg value="app.kubernetes.io/instance=${IR_NAME}"/>
      <arg value="--timeout=300s"/>
      <arg value="-n"/>
      <arg value="${NAMESPACE}"/>
    </exec>
  </target>

  <!-- ================== DEPLOY ================== -->
  <target name="deploy" depends="verify">
    <echo message="✅ BAR Deployment Completed Successfully!"/>
  </target>

</project>
